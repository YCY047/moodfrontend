<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å¿ƒæƒ…æ—¥è¨˜åˆ—è¡¨</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h1>ğŸ“– æ‰€æœ‰å¿ƒæƒ…æ—¥è¨˜</h1>
    <div class="actions">
      <button onclick="location.href='/'">â¬…ï¸ å›åˆ°ä¸Šå‚³å¿ƒæƒ…</button>
      <button onclick="clearToday()">ğŸ§¹ æ¸…é™¤ä»Šå¤©</button>
      <button onclick="clearAll()">ğŸ—‘ï¸ å…¨éƒ¨æ¸…é™¤</button>
    </div>

    <div id="mood-container" class="mood-container">è¼‰å…¥ä¸­...</div>
  </div>

  <script>
    async function loadMoods() {
      const res = await fetch('/summary/all');
      const data = await res.json();
      const container = document.getElementById('mood-container');
      container.innerHTML = '';

      if (!Object.keys(data).length) {
        container.textContent = 'ç›®å‰æ²’æœ‰ä»»ä½•å¿ƒæƒ…è³‡æ–™';
        return;
      }

      const allEntries = [];
      for (const [date, users] of Object.entries(data)) {
        for (const [user, entries] of Object.entries(users)) {
          for (const entry of entries) {
            allEntries.push({ date, user, entry, time: entry.time || '' });
          }
        }
      }

      allEntries.sort((a, b) => new Date(a.time) - new Date(b.time));

      let currentDate = '';
      for (const { date, user, entry } of allEntries) {
        if (date !== currentDate) {
          currentDate = date;
          const dateDiv = document.createElement('div');
          dateDiv.innerHTML = `<h3>${date}</h3>`;
          container.appendChild(dateDiv);
        }

        const entryDiv = document.createElement('div');
        entryDiv.classList.add("entry");

        let moodHtml = '';
        if (entry.mood && typeof entry.mood.text === 'string' && typeof entry.mood.score !== 'undefined') {
          moodHtml = `å¿ƒæƒ…ï¼š${entry.mood.text}ï¼ˆ${entry.mood.score}åˆ†ï¼‰`;
        }

        let photoHtml = '';
        if (entry.photo && typeof entry.photo.file === 'string') {
          photoHtml = `
            <br />
            <img src="/uploads/${entry.photo.file}" alt="${entry.photo.description || ''}" style="max-width: 200px;" />
            <br />
            æè¿°ï¼š${entry.photo.description || ''}
          `;
        }

        if (!moodHtml && !photoHtml) {
          entryDiv.innerHTML = `<p><strong>${user}</strong>ï¼šç„¡å¿ƒæƒ…è³‡æ–™</p>`;
        } else {
          entryDiv.innerHTML = `<p><strong>${user}</strong>ï¼š${moodHtml}${photoHtml}</p><hr>`;
        }

        container.lastElementChild.appendChild(entryDiv);
      }
    }

    async function clearToday() {
      const res = await fetch('/clear/today', { method: 'DELETE' });
      const result = await res.json();
      alert(result.message);
      loadMoods();
    }

    async function clearAll() {
      const res = await fetch('/clear/all', { method: 'DELETE' });
      const result = await res.json();
      alert(result.message);
      loadMoods();
    }

    loadMoods();
  </script>
</body>
</html>
