<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å¿ƒæƒ…æ—¥è¨˜ä¸Šå‚³</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
   
    <h1>ğŸ“ ä¸Šå‚³ä½ çš„å¿ƒæƒ…</h1>
    <!-- ä¸Šå‚³å¿ƒæƒ… -->
    <form id="mood-form" class="form-section" method="post">
      <label>ä½¿ç”¨è€…åç¨±ï¼š<input name="user" required /></label>
      <label>å¿ƒæƒ…æ–‡å­—ï¼š<input name="mood" required /></label>
      <label>åˆ†æ•¸ (1~5)ï¼š<input name="score" type="number" min="1" max="5" required /></label>
      <button type="submit">é€å‡ºå¿ƒæƒ…</button>
    </form>

    <hr />
    <!-- ä¸Šå‚³ç…§ç‰‡ -->
    <h2>ğŸ“· ä¸Šå‚³ç…§ç‰‡</h2>
    <form id="photo-form" class="form-section" enctype="multipart/form-data">
      <label>ä½¿ç”¨è€…åç¨±ï¼š<input name="user" required /></label>
      <label>æè¿°æ–‡å­—ï¼š<input name="description" required /></label>
      <label>
        é¸æ“‡åœ–ç‰‡ï¼š
        <input type="file" name="file" accept="image/*" required id="file-input" />
      </label>
      <img id="photo-preview" style="max-width: 200px; margin-top: 10px; display: none;" />
      <button type="submit">ä¸Šå‚³ç…§ç‰‡</button>
    </form>

    <div class="actions">
      <button onclick="location.href='/diary.html'">ğŸ“– æŸ¥çœ‹æ‰€æœ‰å¿ƒæƒ…æ—¥è¨˜</button>
    </div>
  </div>

  <script>
    // é è¦½åœ–ç‰‡åŠŸèƒ½
    document.getElementById("file-input").addEventListener("change", function (e) {
      const file = e.target.files[0];
      const preview = document.getElementById("photo-preview");

      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          preview.src = e.target.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else {
        preview.src = "";
        preview.style.display = "none";
      }
    });

    document.getElementById("mood-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      await fetch("/mood", { method: "POST", body: form });
      alert("å¿ƒæƒ…å·²é€å‡ºï¼");
      e.target.reset();
    });

    document.getElementById("photo-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      const res = await fetch("/photo", { method: "POST", body: form });
      if (res.ok) {
        alert("ç…§ç‰‡ä¸Šå‚³æˆåŠŸï¼");
        e.target.reset();
        document.getElementById("photo-preview").style.display = "none";
        document.getElementById("photo-preview").src = "";
        loadPhotos();
      } else {
        alert("ç…§ç‰‡ä¸Šå‚³å¤±æ•—ï¼");
      }
    });

    async function loadPhotos() {
      const res = await fetch("/summary/all");
      const data = await res.json();
      const container = document.getElementById("photo-list");
      container.innerHTML = "";
      for (const [date, users] of Object.entries(data)) {
        for (const [user, entries] of Object.entries(users)) {
          for (const entry of entries) {
            if (entry.photo) {
              const img = document.createElement("img");
              img.src = `/uploads/${entry.photo.file}`;
              img.alt = entry.photo.description;
              img.style.maxWidth = "200px";
              img.style.margin = "10px";

              const caption = document.createElement("p");
              caption.textContent = `${date} ${user}ï¼š${entry.photo.description}`;

              const wrapper = document.createElement("div");
              wrapper.appendChild(img);
              wrapper.appendChild(caption);

              container.appendChild(wrapper);
            }
          }
        }
      }
    }

    loadPhotos();
  </script>
</body>
</html>
